# More information about this section can be found in the following location
# https://docs.gitlab.com/ee/ci/yaml/#include

include:
  - local: "acmecorp.apexaltruism.net/function/serve.yml"
  - local: "acmecorp.apexaltruism.net/function/cease.yml"
  - local: "apexaltruism.net/function/serve.yml"
  - local: "apexaltruism.net/function/cease.yml"
  - local: "chat.apexaltruism.net/function/serve.yml"
  - local: "chat.apexaltruism.net/function/cease.yml"
  - local: "code.apexaltruism.net/function/serve.yml"
  - local: "code.apexaltruism.net/function/cease.yml"
  - local: "dash.apexaltruism.net/function/serve.yml"
  - local: "dash.apexaltruism.net/function/cease.yml"
  - local: "download.apexaltruism.net/function/serve.yml"
  - local: "download.apexaltruism.net/function/cease.yml"
  - local: "explorer.apexaltruism.net/function/serve.yml"
  - local: "explorer.apexaltruism.net/function/cease.yml"
  - local: "jump.apexaltruism.net/function/serve.yml"
  - local: "jump.apexaltruism.net/function/cease.yml"
  - local: "leantime.apexaltruism.net/function/serve.yml"
  - local: "leantime.apexaltruism.net/function/cease.yml"
  - local: "taskplan.apexaltruism.net/function/serve.yml"
  - local: "taskplan.apexaltruism.net/function/cease.yml"
  - local: "vscode-main.apexaltruism.net/function/serve.yml"
  - local: "vscode-main.apexaltruism.net/function/cease.yml"
  - local: "wirezone.apexaltruism.net/function/serve.yml"
  - local: "wirezone.apexaltruism.net/function/cease.yml"
  - local: "work.apexaltruism.net/function/serve.yml"
  - local: "work.apexaltruism.net/function/cease.yml"

# Mirror the source repository available on GitLab to the destination 
# repository available on GitHub whenever a push is made to the primary branch
# of the source repository.

push-sync-github:
  image: "fedora:latest"
  script:
    - echo "Install Git and its dependencies"
    - dnf install git --setopt=install_weak_deps=False --assumeyes
    - echo "Adding destination repository as a remote"
    - git --git-dir=$CI_PROJECT_DIR/.git remote add githubac https://t0xic0der:$githubac@github.com/t0xic0der/frontier.git
    - echo "Pushing the changes to the destination repository"
    - git --git-dir=$CI_PROJECT_DIR/.git push githubac main
  rules:
    - if: $CI_PIPELINE_SOURCE = "push"
      when: "on_success"

# The initial stage requires setting proper permissions for the keyfiles
# This is to ensure that the "Host key verification failed" error is avoided
# This error happens due to the "UNPROTECTED PRIVATE KEY FILE" error

default:
  image: "fedora:37"
  before_script:
    - echo "Setup secure shell client configuration for automatic authentication"
    - mkdir -p "/root/.ssh/" && chmod 700 "/root/.ssh/"
    - cat "$privcode_trsa" > "/root/.ssh/id_rsa" && chmod 600 "/root/.ssh/id_rsa"
    - cat "$publcode_trsa" > "/root/.ssh/id_rsa.pub" && chmod 644 "/root/.ssh/id_rsa.pub"
    - cat "$sshdconf" > "/root/.ssh/config" && chmod 644 "/root/.ssh/config"
    - echo "Install 'Ansible' package required for setting up the configuration files"
    - dnf install "ansible" --setopt=install_weak_deps=False --assumeyes
    - echo "Install 'OpenSSH Clients' package required for setting up the configuration files"
    - dnf install "openssh-clients" --setopt=install_weak_deps=False --assumeyes
    - echo "Install 'Docker CE' package required for deploying the stated service"
    - dnf install "dnf-plugins-core" --setopt=install_weak_deps=False --assumeyes
    - dnf config-manager --add-repo "https://download.docker.com/linux/fedora/docker-ce.repo"
    - dnf install "docker-ce" "docker-compose-plugin" --setopt=install_weak_deps=False --assumeyes

# Pre-defined variables reference can be found in the following location
# https://docs.gitlab.com/ee/ci/variables/predefined_variables.html
